# E2Eテスト仕様書: コード品質改善リファクタリング

## 目的

Phase 1〜4のリファクタリング後、既存機能が全て正常動作することを確認する回帰テスト。

## 前提条件

- YouTube API キーが `.streamlit/secrets.toml` に設定済み
- `pip install -r requirements.txt` 実行済み
- `streamlit run app.py` でアプリ起動済み

---

## テストケース一覧（10項目）

| ID | シナリオ | フロー内容 | 期待結果 |
|----|---------|-----------|---------|
| E2E-001 | 急上昇トレンド取得フロー | ボタン押下→API取得→表示→CSV | 全カテゴリの動画取得・キーワードランキング・CSVダウンロードが正常動作 |
| E2E-002 | ジャンル別ランキング（キーワードなし） | カテゴリ選択→ボタン→表示 | mostPopular APIで動画取得・ランキング表示 |
| E2E-003 | ジャンル別ランキング（キーワードあり） | キーワード入力→カテゴリ選択→ボタン→表示 | search APIで動画取得・ランキング表示 |
| E2E-004 | サジェスト基本取得フロー | キーワード入力→基本取得ボタン→表示 | Googleサジェストから候補取得・一覧表示 |
| E2E-005 | サジェストアルファベットスープフロー | キーワード入力→アルファベットスープボタン→完了→CSV | 82サフィックス巡回・進捗バー・重複排除・CSV |
| E2E-006 | バズ動画分析フロー | キーワード→フィルタ設定→分析ボタン→結果 | 検索→V/S比率計算→フィルタ→ソート→表示 |
| E2E-007 | トレンド急上昇ワード取得フロー | トレンド調査タブ→急上昇ワードボタン→表示 | Google Trends RSSから取得・ニュース表示 |
| E2E-008 | トレンド検索ボリューム調査フロー | キーワード→期間選択→調査ボタン→チャート | pytrends検索ボリューム推移・関連キーワード表示 |
| E2E-009 | サイドバーフィルタ連動確認 | フィルタ値変更→バズ動画分析実行 | フィルタ変更がバズ分析結果に反映される |
| E2E-010 | クォータ表示の正確性 | 任意のAPI呼び出し→サイドバー確認 | API呼び出し後にクォータメーター更新される |

---

## 詳細シナリオ

### E2E-001: 急上昇トレンド取得フロー

**前提条件**: アプリ起動済み、APIキー設定済み
**操作手順**:
1. 「急上昇トレンド」タブをクリック
2. 「急上昇動画を取得」ボタンをクリック
3. ローディング完了まで待機
4. 表示された動画一覧を確認
5. キーワードランキングの表示を確認
6. 「CSVダウンロード」ボタンをクリック

**期待結果**:
- 複数カテゴリの動画がグリッド形式で表示される
- 各動画にサムネイル・タイトル・再生数・チャンネル名が表示される
- キーワード頻出ランキングが表示される
- CSVファイルがダウンロードされる

**検証ポイント**:
- `tab_trending.render()` が正常に呼び出される
- `SessionKeys.TRENDING_VIDEOS` にデータが保存される
- `ui_components.display_video_grid_raw()` が正しく動作する

---

### E2E-002: ジャンル別ランキング取得フロー（キーワードなし）

**前提条件**: アプリ起動済み
**操作手順**:
1. 「ジャンル別ランキング」タブをクリック
2. カテゴリを選択（例: 音楽）
3. キーワードは空のまま
4. 「ランキングを取得」ボタンをクリック

**期待結果**:
- 選択カテゴリの人気動画が表示される
- mostPopular APIが使用される（searchではない）
- 動画のサムネイル・タイトル・統計情報が表示される

**検証ポイント**:
- `tab_genre._fetch_without_keyword()` パスが実行される
- `SessionKeys.GENRE_VIDEOS` にデータが保存される

---

### E2E-003: ジャンル別ランキング取得フロー（キーワードあり）

**前提条件**: アプリ起動済み
**操作手順**:
1. 「ジャンル別ランキング」タブをクリック
2. キーワードを入力（例: 投資）
3. カテゴリを選択
4. 「ランキングを取得」ボタンをクリック

**期待結果**:
- キーワードに関連する動画が表示される
- search APIが使用される
- V/S比率が計算・表示される

**検証ポイント**:
- `tab_genre._fetch_with_keyword()` パスが実行される
- `analyzer.fetch_and_analyze()` が正常動作する

---

### E2E-004: サジェスト基本取得フロー

**前提条件**: アプリ起動済み
**操作手順**:
1. 「サジェストキーワード」タブをクリック
2. サイドバーにキーワードが入力されていることを確認
3. 「基本サジェストを取得」ボタンをクリック

**期待結果**:
- Google Suggest APIからサジェスト候補が取得される
- 候補一覧が表示される
- APIクォータは消費されない（Google Suggestは非公式APIのため）

**検証ポイント**:
- `suggest_api.fetch_suggestions()` が正常動作する
- `SessionKeys.BASE_SUGGESTIONS` にデータが保存される

---

### E2E-005: サジェストアルファベットスープフロー

**前提条件**: 基本サジェスト取得済み（E2E-004完了後）
**操作手順**:
1. 「アルファベットスープ取得」ボタンをクリック
2. 進捗バーの更新を確認
3. 完了まで待機（約2分）
4. 結果一覧を確認
5. CSVダウンロードボタンをクリック

**期待結果**:
- 82サフィックス（50音46+英字26+数字10）を順に巡回する
- 進捗バーがリアルタイム更新される
- 重複排除された全サジェスト一覧が表示される
- CSVファイルがダウンロードされる

**検証ポイント**:
- `suggest_api.fetch_suggestions_with_alphabet_soup()` が正常動作する
- `suggest_api.flatten_unique_suggestions()` で重複排除される
- `SessionKeys.ALL_SUGGESTIONS` にデータが保存される
- ログに `alphabet_soup: completed, N total suggestions` が出力される

---

### E2E-006: バズ動画分析フロー

**前提条件**: アプリ起動済み
**操作手順**:
1. 「バズ動画分析」タブをクリック
2. サイドバーでフィルタを設定
   - 登録者数上限: 50000
   - 再生数下限: 10000
   - V/S比率下限: 1.0
3. 「分析開始」ボタンをクリック

**期待結果**:
- 検索結果がV/S比率でソートされて表示される
- フィルタ条件に合致する動画のみ表示される
- DataFrameにタイトル・チャンネル・再生数・登録者数・V/S比率・公開日が含まれる

**検証ポイント**:
- `analyzer.fetch_and_analyze()` → `filter_videos()` → `sort_by_vs_ratio()` のパイプラインが正常動作
- `SessionKeys.ANALYZED_VIDEOS` にデータが保存される
- `ui_components.csv_download_button()` が正常動作する

---

### E2E-007: トレンド急上昇ワード取得フロー

**前提条件**: アプリ起動済み
**操作手順**:
1. 「トレンド調査」タブをクリック
2. 「急上昇ワードを取得」ボタンをクリック

**期待結果**:
- Google Trends RSSから急上昇ワードが取得される
- 各ワードに関連ニュース（タイトル・ソース・URL）が表示される
- 推定検索ボリュームが表示される

**検証ポイント**:
- `trends_api.get_trending_searches()` が正常動作する
- XML解析が正しく行われる
- `SessionKeys.TRENDING_SEARCHES` にデータが保存される

---

### E2E-008: トレンド検索ボリューム調査フロー

**前提条件**: アプリ起動済み
**操作手順**:
1. 「トレンド調査」タブをクリック
2. 期間を選択（例: 過去12ヶ月）
3. 「検索ボリュームを調査」ボタンをクリック

**期待結果**:
- 検索ボリューム推移チャートが表示される
- 関連キーワード（急上昇・人気）が表示される
- ピーク日・現在値の情報が表示される

**検証ポイント**:
- `trends_api.get_interest_over_time()` が正常動作する
- `trends_api.get_related_queries()` が正常動作する
- `constants.TREND_PERIOD_MAP` のマッピングが正しく適用される
- `SessionKeys.TREND_INTEREST` / `TREND_RELATED` にデータが保存される

---

### E2E-009: サイドバーフィルタ連動確認

**前提条件**: バズ動画分析を1回実行済み（E2E-006完了後）
**操作手順**:
1. サイドバーのフィルタ値を変更（例: 登録者数上限を100000に変更）
2. 「バズ動画分析」タブで再度「分析開始」をクリック
3. 結果が変わったことを確認

**期待結果**:
- フィルタ条件の変更が正しく反映される
- 登録者数上限を上げた場合、より多くの動画が表示される
- 期間フィルタの変更も正しく反映される

**検証ポイント**:
- `tab_buzz.render()` にフィルタパラメータが正しく渡される
- `analyzer.filter_videos()` のフィルタロジックが正常動作する

---

### E2E-010: クォータ表示の正確性

**前提条件**: アプリ起動済み
**操作手順**:
1. サイドバーのクォータ表示を確認（初期状態: 0 / 10,000）
2. 「バズ動画分析」で分析を実行
3. サイドバーのクォータ表示を再確認

**期待結果**:
- search API呼び出し後: +100ユニット
- videos.list 呼び出し後: +1ユニット（バッチごと）
- channels.list 呼び出し後: +1ユニット（バッチごと）
- メーターとプログレスバーが更新される

**検証ポイント**:
- `QuotaTracker.add()` が正しく呼ばれる
- `SessionKeys.QUOTA_TRACKER` を通じた状態管理が正常
- `QuotaTracker.usage_percent` / `remaining` の計算が正しい
